<div class="exercise-title-card text-center mb-4 p-3">
  <h3 class="m-0"><%= @exercise.name %></h3>
</div>

<div class="exercise-card">

  <%= form_with url: update_group_workout_workout_sets_path(@workout),
                method: :patch,
                local: true do %>

    <%= hidden_field_tag :exercise_id, @exercise.id %>

    <!-- Stimulus セット編集コントローラ -->
    <div data-controller="sets" data-sets-edit-mode-value="true" data-sets-workout-id-value="<%= @workout.id %>">

      <button
        type="button"
        class="sets-back-button"
        data-action="click->sets#commitOrBack">
        ＜
      </button>
      
      <!-- 既存セット行のコンテナ -->
      <div data-sets-target="list">

        <% @sets.each_with_index do |set, i| %>
          <div class="set-input-row mb-3 p-3 rounded"
              style="background-color: #0f2033; border: 1px solid rgba(255,255,255,0.08);"
              data-set-uuid="<%= set.id %>"
              data-persisted="true"
              data-controller="workout-set-create">

            <!-- 番号ラベル（Stimulus が再計算する） -->
            <div class="set-number-label mb-2 fw-bold text-light"
                data-sets-target="number">
              セット<%= i + 1 %>
            </div>

            <div class="d-flex gap-3">
              <div class="flex-fill">
                <label class="form-label">重量(kg)</label>
                <%= number_field_tag "",
                                     set.weight,
                                     step: 0.5,
                                     class: "form-control",
                                     data: { workout_set_create_target: "weight", action: "input->workout-set-create#saveDraft" } %>
              </div>

              <div class="flex-fill">
                <label class="form-label">回数</label>
                <%= number_field_tag "",
                                     set.reps,
                                     class: "form-control",
                                     data: { workout_set_create_target: "reps", action: "input->workout-set-create#saveDraft" } %>
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">メモ</label>
              <%= text_area_tag "",
                                set.memo,
                                rows: 1,
                                class: "form-control",
                                data: { workout_set_create_target: "memo", action: "input->workout-set-create#saveDraft" } %>
            </div>

          </div>
        <% end %>

      </div>

      <!-- 新規追加用テンプレート -->
      <template data-sets-target="template">
        <div class="set-input-row mb-3 p-3 rounded"
            style="background-color: #0f2033; border: 1px solid rgba(255,255,255,0.08);">

          <div class="set-number-label mb-2 fw-bold text-light"
              data-sets-target="number">
            セット
          </div>

          <div class="d-flex gap-3">
            <div class="flex-fill">
              <label class="form-label">重量(kg)</label>
              <input type="number"
                     step="0.5"
                     class="form-control"
                     data-sets-target="weight">
            </div>

            <div class="flex-fill">
              <label class="form-label">回数</label>
              <input type="number"
                     class="form-control"
                     data-sets-target="reps">
            </div>
          </div>

          <div class="mt-2">
            <label class="form-label">メモ</label>
            <textarea rows="1"
                      class="form-control"
                      data-sets-target="memo"></textarea>
          </div>

        </div>
      </template>

      <!-- セット追加ボタン -->
      <button type="button"
              class="btn btn-secondary w-100 mt-3"
              data-action="sets#add">
        ＋ セットを追加
      </button>

      <!-- 保存ボタン -->
      <button type="button"
              class="btn btn-primary w-100 mt-3"
              data-action="click->sets#commit">
        保存する
      </button>

    </div>

  <% end %>

</div>
